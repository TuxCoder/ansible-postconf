---
# .. vim: foldmarker=[[[,]]]:foldmethod=marker

# debops.postpolicy default variables [[[
# =====================================

# .. contents:: Sections
#    :local:
#
# .. include:: includes/all.rst


# Postfix capabilities [[[
# ------------------------

# These variables roughly define what functionality will be enabled in Postfix.
# See :ref:`postpolicy__ref_capabilities` for more details.

# .. envvar:: postpolicy__autodetect_capabilities [[[
#
# List of Postfix capabilities enabled dynamically during role execution.
postpolicy__autodetect_capabilities: '{{ postconf__env_capabilities }}'

                                                                   # ]]]
# .. envvar:: postpolicy__default_capabilities [[[
#
# List of Postfix capabilities enabled by default by the role.
postpolicy__default_capabilities: [ 'overhead' ]

                                                                   # ]]]
# .. envvar:: postpolicy__capabilities [[[
#
# List of Postfix capabilities which should be enabled on all hosts in the
# Ansible inventory.
postpolicy__capabilities: []

                                                                   # ]]]
# .. envvar:: postpolicy__group_capabilities [[[
#
# List of Postfix capabilities which should be enabled on hosts in specific
# Ansible inventory group.
postpolicy__group_capabilities: []

                                                                   # ]]]
# .. envvar:: postpolicy__host_capabilities [[[
#
# List of Postfix capabilities which should be enabled in specific hosts in the
# Ansible inventory.
postpolicy__host_capabilities: []

                                                                   # ]]]
# .. envvar:: postpolicy__combined_capabilities [[[
#
# List that combines all Postfix capabilities from the other variables and is
# used in other configuration variables and Ansible tasks.
postpolicy__combined_capabilities: '{{ postconf__autodetect_capabilities
                                     + postpolicy__default_capabilities
                                     + postpolicy__capabilities
                                     + postpolicy__group_capabilities
                                     + postpolicy__host_capabilities }}'
                                                                   # ]]]
                                                                   # ]]]
# Postfix configuration variables [[[
# -----------------------------------

# .. envvar:: postpolicy__fqdn [[[
#
# The Fully Qualified Domain Name of this SMTP host.
postpolicy__fqdn: '{{ ansible_local.core.fqdn
                    if (ansible_local|d() and ansible_local.core|d() and
                        ansible_local.core.fqdn|d())
                    else ansible_fqdn }}'

                                                                   # ]]]
# .. envvar:: postpolicy__unauth_sender_domains [[[
#
# List of FQDN domains which are handled by this Postfix instance. Any
# unauthenticated mail messages from these domains that are sent from external
# hosts will be blocked. This list should be synchronized with the Postfix
# ``$mydestination``, ``$relay_domains``, ``$virtual_mailbox_domains`` and
# ``$virtual_alias_domains`` configuration parameters.
postpolicy__unauth_sender_domains: [ '{{ postconf__fqdn }}' ]

                                                                   # ]]]
# .. envvar:: postpolicy__unauth_sender_default_action [[[
#
# The error message which will be sent to the SMTP servers that try to deliver
# unauthenticated mail messages.
postpolicy__unauth_sender_default_action: 'REJECT This server requires SMTP authentication'
                                                                   # ]]]
                                                                   # ]]]
# Postfix lookup tables [[[
# -------------------------

# These lists define Postfix lookup tables placed in the :file:`/etc/postfix/`
# directory. The configuration format is specified in the debops.postfix_ role
# documentation.

# .. envvar:: postpolicy__default_lookup_tables [[[
#
# List of default lookup tables defined by the role.
postpolicy__default_lookup_tables:

  - name: 'auth_header_checks.pcre'
    by_role: 'debops.postpolicy'
    comment: |
      Cleanup headers in mail messages sent by authenticated clients through
      submission/smtps service.

      Documentation: https://askubuntu.com/questions/78163/
    default_action: 'IGNORE'
    options:
      - '/^X-Mailer:/':   'IGNORE'
      - '/^User-Agent:/': 'IGNORE'
    state: '{{ "present"
               if ("authcleanup" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'mx_access.cidr'
    by_role: 'debops.postpolicy'
    comment: |
      Check if HELO or sender MX server is in subnets not accessible from the
      public Internet. If so, reject mail delivery from these servers, because
      any replies will be non-deliverable.
    options:
      - '0.0.0.0/8':       'REJECT Domain MX in broadcast network'
      - '10.0.0.0/8':      'REJECT Domain MX in RFC 1918 private network'
      - '127.0.0.0/8':     'REJECT Domain MX in loopback network'
      - '169.254.0.0/16':  'REJECT Domain MX in link local network'
      - '172.16.0.0/12':   'REJECT Domain MX in RFC 1918 private network'
      - '192.0.2.0/24':    'REJECT Domain MX in TEST-NET-1 network'
      - '192.168.0.0/16':  'REJECT Domain MX in RFC 1918 private network'
      - '198.51.100.0/24': 'REJECT Domain MX in TEST-NET-2 network'
      - '203.0.113.0/24':  'REJECT Domain MX in TEST-NET-3 network'
      - '224.0.0.0/4':     'REJECT Domain MX in class D multicast network'
      - '240.0.0.0/5':     'REJECT Domain MX in class E reserved network'
      - '248.0.0.0/5':     'REJECT Domain MX in reserved network'

      - '::1/128':         'REJECT Domain MX is Loopback address'
      - '::/128':          'REJECT Domain MX is Unspecified address'
      - '::/96':           'REJECT Domain MX in IPv4-Compatible IPv6'
      - '::ffff:0:0/96':   'REJECT Domain MX in IPv4-Mapped IPv6'
      - 'ff00::/8':        'REJECT Domain MX in Multicast network'
      - 'fe80::/10':       'REJECT Domain MX in Link-local unicast network'
      - 'fec0::/10':       'REJECT Domain MX in Site-local unicast network'
    state: '{{ "present"
               if ("public-mx-required" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'unauth_sender_access.in'
    by_role: 'debops.postpolicy'
    comment: |
      Block any unauthenticated external mail that uses our domain names. Users
      that send this mail need to enable SMTP authentication and use the
      'submission' service.

      Documentation: https://serverfault.com/a/51122
    default_action: '{{ postpolicy__unauth_sender_default_action }}'
    content: '{{ postpolicy__unauth_sender_domains }}'
    state: '{{ "present"
               if ("auth" in postpolicy__combined_capabilities and
                   "unauth-sender" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'overhead_checks.pcre'
    by_role: 'debops.postpolicy'
    comment: |
      "A man is not dead while his name is still spoken."
                - Going Postal, Chapter 4 prologue

      Ref: http://www.gnuterrypratchett.com/
    options:
      - '/^X-Clacks-Overhead:/': 'IGNORE'
      - '/^To:/': 'PREPEND X-Clacks-Overhead: GNU Terry Pratchett'
    state: '{{ "present"
               if ("overhead" in postpolicy__combined_capabilities)
               else "ignore" }}'

                                                                   # ]]]
# .. envvar:: postpolicy__lookup_tables [[[
#
# List of lookup tables that are managed on all hosts in the Ansible inventory.
postpolicy__lookup_tables: []

                                                                   # ]]]
# .. envvar:: postpolicy__group_lookup_tables [[[
#
# List of lookup tables that are managed on hosts in specific Ansible inventory
# group.
postpolicy__group_lookup_tables: []

                                                                   # ]]]
# .. envvar:: postpolicy__host_lookup_tables [[[
#
# List of lookup tables that are managed on specific hosts in the Ansible
# inventory.
postpolicy__host_lookup_tables: []

                                                                   # ]]]
# .. envvar:: postpolicy__combined_lookup_tables [[[
#
# Variable that combines the other lookup table lists together for eas of use.
postpolicy__combined_lookup_tables: '{{ postconf__default_lookup_tables
                                      + postpolicy__lookup_tables
                                      + postpolicy__group_lookup_tables
                                      + postpolicy__host_lookup_tables }}'
                                                                   # ]]]
                                                                   # ]]]
# Configuration for other Ansible roles [[[
# -----------------------------------------

# .. envvar:: postpolicy__postfix__dependent_lookup_tables [[[
#
# Lookup table configuration passed to the debops.postfix_ Ansible role.
postpolicy__postfix__dependent_lookup_tables:
  - '{{ postpolicy__combined_lookup_tables }}'

                                                                   # ]]]
# .. envvar:: postpolicy__postfix__dependent_maincf [[[
#
# The :file:`main.cf` configuration passed to the debops.postfix_ Ansible role.
postpolicy__postfix__dependent_maincf:

  - name: 'smtpd_sasl_auth_enable'
    value: True
    state: '{{ "present"
               if ("auth" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'smtpd_sasl_authenticated_header'
    value: True
    state: '{{ "present"
               if ("auth" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'broken_sasl_auth_clients'
    value: True
    state: '{{ "present"
               if ("auth" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'smtpd_sasl_security_options'
    value: [ 'noanonymous', 'noplaintext' ]
    state: '{{ "present"
               if ("auth" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'smtpd_sasl_tls_security_options'
    value: [ 'noanonymous' ]
    state: '{{ "present"
               if ("auth" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'smtpd_sasl_type'
    value: '{{ "dovecot"
               if (ansible_local|d() and ansible_local.dovecot|d() and
                   (ansible_local.dovecot.installed|d())|bool)
               else "cyrus" }}'
    state: '{{ "present"
               if ("auth" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'smtpd_sasl_path'
    value: '{{ "private/auth"
               if (ansible_local|d() and ansible_local.dovecot|d() and
                   (ansible_local.dovecot.installed|d())|bool)
               else "smtpd" }}'
    state: '{{ "present"
               if ("auth" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'smtpd_helo_restrictions'
    value:
      - name: 'check_helo_mx_access cidr:${config_directory}/mx_access.cidr'
    state: '{{ "present"
               if ("public-mx-required" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'smtpd_sender_restrictions'
    value:
      - name: 'check_sender_mx_access cidr:${config_directory}/mx_access.cidr'
        weight: 50
    state: '{{ "present"
               if ("public-mx-required" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'smtpd_sender_restrictions'
    value:

      - name: 'permit_mynetworks'

      - name: 'permit_sasl_authenticated'
        copy_id_from: 'permit_mynetworks'
        weight: 10

      - name: 'check_sender_access hash:${config_directory}/unauth_sender_access'
        copy_id_from: 'permit_sasl_authenticated'
        weight: 10

    state: '{{ "present"
               if ("auth" in postpolicy__combined_capabilities and
                   "unauth-sender" in postpolicy__combined_capabilities)
               else "ignore" }}'

  - name: 'header_checks'
    value: [ 'pcre:${config_directory}/overhead_checks.pcre' ]
    state: '{{ "present"
               if ("overhead" in postpolicy__combined_capabilities)
               else "ignore" }}'

                                                                   # ]]]
# .. envvar:: postpolicy__postfix__dependent_mastercf [[[
#
# The :file:`master.cf` configuration passed to the debops.postfix_ Ansible
# role.
postpolicy__postfix__dependent_mastercf:

  - name: 'policy-spf'
    type: 'unix'
    private: False
    maxproc: 0
    command: 'spawn'
    options:
      - value: 'user=nobody argv=/usr/bin/policyd-spf'
    state: '{{ "present"
               if ("spf" in postpolicy__combined_capabilities)
               else "ignore" }}'
    copy_id_from: 'cleanup'
    weight: 10
                                                                   # ]]]
                                                                   # ]]]
                                                                   # ]]]
